stages:
  - test
  - build

variables:
  CONTAINER_TEST_IMAGE: git.mygait.com:4567/cgaspard/seemless
  CONTAINER_RELEASE_IMAGE: git.mygait.com:4567/cgaspard/seemless
  TEST_TAG: qalatest
  RELEASE_TAG: latest

image: node:7.7.2

unit_tests:
  stage: test
  before_script:
    - npm update --silent > /dev/null
    - npm install --silent -g tape > /dev/null
    - npm install --silent -g faucet > /dev/null
  script:
    - tape tests/*.js | faucet

build-qa-container:
  stage: build
  before_script:
    - docker info
  script: 
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN git.mygait.com:4567
    - docker build --file .dockerfile -t $TEST_TAG .
    - docker push $CONTAINER_TEST_IMAGE:$TEST_TAG
  only:
    - dev

build-staging-container:
  stage: build
  before_script:
    - docker info
  script: 
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN git.mygait.com:4567
    - docker build --file .dockerfile -t $RELEASE_TAG .
    - docker push $CONTAINER_RELEASE_IMAGE:$RELEASE_TAG
  only: 
    - master